---
title: "TypeScript, node.js и файлы-файлики"
layout: post
---

Про TypeScript, node.js и порядок компиляции файлов

Несколько недель писал свою тексто-игру на TypeScript, но позже подзабросил. Проект был отчатсти успешный: я лучше узнал TypeScript. На этом плюсы от проекта заканчиваются.

Кроме того, недавно опробовал TypeScript на node.js. То есть, я уже успел попробовать TypeScript и в браузере, и в ноде.

Ну так вот, что хочу сказать... У TypeScript есть разные режимы компиляции... Один из режимов - всё совать в один большой файл. Так вот, режим этот не самый лучший. Почему? Потому что есть такая страшная вещь как тэг reference...

Допустим, проект на TypeScript состоит из нескольких файлов. При этом некоторые файлы должны идти раньше, чем другие. Например, есть класс App. Логично что он должен быть объявлен раньше, чем у меня вызывается new App(). Но в TypeScript почему-то такого не сделали, а сделали так что файлы компилируются в случайном порядке, и может легко получиться так, что у меня new App() будет раньше чем class App{}... и прога упадёт.

Что же мы имеем в итоге? Прога может упасть от неправильного порядка компоновки файлов, сама по себе. Есть несколько путей решения проблемы:

* Писать весь проект в одном файле с исходным кодом
* Писать тэг reference везде и всюду (все нужные тебе файлы тебе надо зареференсить, а если забыл зареференсить, прога может упасть, а может и не упасть - как повезёт. А может упасть, но не сразу, а когда-нибудь потом).
* Создать отдельный reference-файл в котором один раз указать правильный порядок всех файлов. Можно делать по одному файлу на каждую папку или библиотеку, тогда надо будет ещё создать корневой reference-файл, в котором надо будет в правильном порядке референсить все свои библиотеки и папки.
* Использовать отдельный загрузчик модулей js

Последний из перечисленных путей - самый "правильный". При этом TypeScript будет из каждого ts-файла генерировать только один .js файл... И нужно тогда использовать ещё один компилятор: WebPack, либо Parcel, либо какой-то ещё компилятор... И тут становится непонятно, почему когда я использую компилятор TypeScript, я должен настраивать ЕЩЁ один компилятор, чтобы компилировать файлы скомпилированные компилятором TypeScript. И это раздражает. В таком случае лучше вообще не ставить TypeScript отдельно, а использовать Parcel который из коробки компилирует TypeScript. (но там могут быть свои сложности, я особо не изучал это)

В своих мини-проектах которые я до этого писал я в основном использовал разные комбинации референс-тэгов, хотя и WebPack тоже пробовал. Но мой самый большой проект - текстоигра - сделан на референсах. И очень легко запутаться в них или забыть включить файл в reference-список.

```xml
///<reference path="./AttrPanel.tsx"/>
///<reference path="./Stats.tsx"/>
///<reference path="./MenuPanel.tsx"/>
...
```

Выше я писал, что опробовал TypeScript и для node. Считаю что это хорошо и удобно. Написал мини-проект на node & TS для работы. Причём первоначально проект был на JavaScript, а где-то спустя неделю я портировал его на TypeScript. Проект от этого выиграл, на мой взгляд. И ещё одна деталь: референсы для node не нужны, потому что там и так есть свой загрузчик модулей. Можно использовать только TypeScript-компилятор без WebPack и прочих. Удобно, что можно писать типы, а можно и не писать. Для всех своих классов можно сразу писать типы, а для сторонних библиотек можно писать поначалу без типов. Например, в офисе надо было делать запросы к базе, а запросы пишутся в json-объектах. И эти объекты имеют довольно чёткую структуру, и ответы тоже, но описывать типы для всех них сразу я не стал. Искать готовые типы я впрочем тоже не стал (а можно было). Так и получается: часть проекта с типами, а часть проекта без типов. Некоторые части ответов базы я вообще не обрабатывал, поэтому и типы для них не потребовались.

В TypeScript для node есть один такой "подводный камень": надо включить поддержку sourceMap отдельно. Иначе когда скрипты упадут, будет не ясно, на какой строке (хотя по названиям методов можно догадаться). Включить sourceMap очень просто: ставится один пакет и добваляется одна строка кода в main.js. После этого можно "спокойно" писать node-скрипты на TypeScript.

